{% load i18n %}

<!-- the standard view -->
<div id="machinesview" class="standard">
    <div id="spinner"></div>
    <div class="machine-container" id="machine-container-template" style="display:none">
        <div class="machine" id="machine-template" \>
            <div class="actions">
                <a href="#" class="action-start">{% trans "Start" %}</a>
                <a href="#" class="action-reboot">{% trans "Reboot" %}</a>
                <a href="#" class="action-shutdown">{% trans "Shutdown" %}</a>
                <a href="#" class="action-console">{% trans "Console" %}</a>
                <a href="#" class="action-destroy">{% trans "Destroy" %}</a>
            </div>  
            <div class="confirm_single">
                <button class="yes">{% trans "Confirm" %}</button>
                <button class="no">{% trans "Cancel" %}</button>
            </div>      
            <div class="state">
                <div class="status">{% trans "Running" %}</div>
                <div class="indicator"></div>
                <div class="indicator"></div>
                <div class="indicator"></div>
                <div class="indicator"></div>
                <img class="spinner" style="display:none" src="/static/progress.gif" />
                <img class="wave" style="display:none" src="/static/wave.gif" />
            </div>
            <img class="logo" src="" />
            <div href="#" class="name">
                <h5 class="namecontainer editable">
                    {% trans "Name: " %}<span class="name">node.name</span><span class="rename"></span>
                    <div class="editbuttons" style="display:none">
                        <span class="save" />
                        <span class="cancel" />
                    </div>
                </h5>
            </div>
            <a href="#" class="ip">
                <h5>{% trans "IP: " %}<span class="public">node.public_ip</span></h5>
            </a>
            <h5 class="settings">
                {% trans "Show:" %} 
                <a class="show-disks" href="#">{% trans "disks" %}</a> | 
                <a class="show-networks" href="#">{% trans "networks" %}</a> | 
                <a class="show-info" href="#">{% trans "more info" %}</a>
            </h5>
            <div class="info-content">
                <div class="metadata-separator"></div>
                <div class="metadata-container">
                    <div class="vm-details metadata-column">
                        CPUs: <span class="cpu-data">1</span><br />
                        RAM: <span class="ram-data">2048</span> (MB)<br />
                        System Disk: <span class="disk-data">20</span> (GB) <br /><br />
                        Image: <span class="image-data">Debian</span><br />
                        Image Size: <span class="image-size-data">2.3</span> (GB)
                    </div>
                    <div class="vm-stats metadata-column">
                        CPU <img src="/static/cpu-bar.png" class="metadata-bar" /><br />
                        RAM <img src="/static/ram-bar.png" class="metadata-bar" /><br />
                        S.Disk <img src="/static/cpu-bar.png" class="metadata-bar" /><br />
                        Net <img src="/static/net-bar.png" class="metadata-bar" /><br /><br />
                        details
                    </div>
                    <div class="vm-labels metadata-column">
                        <div class="metadata-left">
                            Labels<br />
                            (4)
                        </div>
                        <div class="metadata-keys-container">
                            debian<br />
                            my_servers<br />
                            critical
                        </div>
                    </div>
                    <div class="vm-metadata metadata-column">
                        <div class="metadata-left">
                            Metadata:<br />
                            (<span class="metadata-count">0</span>)
                        </div>
                        <div class="metadata-keys-container">
                            <div class="scrollable vertical">
                                <div class="items">
                                    
                                </div>
                            </div>
                            <div class="metadata-actions">
                                <a class="prev" href="#">&lt;</a>
                                <a class="next" href="#">&gt;</a>
                            </div>
                        </div>
                        <a href="#" class="manage-metadata">Manage Tags</a>
                    </div>
                </div>
                <div class="metadata-separator"></div>
            </div>
            <div class="action_error" align="center">
                {% trans "<span class='orange'>Error</span> on" %} <span class="action">{% trans "error action" %}</span>
                <span class="code"></span>            
                <span class="message"></span>
                <button class="details">{% trans "Details" %}</button>
            </div>
        </div>
        <div class="separator"></div>
    </div>
    <div class="running"></div>
    <div id="mini" class="separator"></div>
    <div class="terminated"></div>
</div>

<script>

//hide the all of the info contents
$(".info-content").hide();
//toggle the component with class info-content
$("a.show-info").live('click', function() {
    $(this).parent().parent().find(".info-content").slideToggle(600);
    return false;
});


// intercept manage metadata click
$("a.manage-metadata").live('click', function() {
    // get server name and server ID
    var serverID = $(this).parent().parent().parent().parent().parent().attr("id");
    var serverName = $(this).parent().parent().parent().parent().parent().find("span.name").text();
    // set server name to all related metadata dialogs
    $("#edit-dialog h3 span").text(serverName);
    $("#add-dialog h3 span").text(serverName);
    // set server id to all related metadata dialogs
    $("#edit-dialog h3 p").text(serverID);
    $("#add-dialog h3 p").text(serverID);
    show_metadata_wizard();
    return false;
});

//initiate machine renaming
$(".rename, h5.editable span.name").live('click', function() {
    $(this).parent().find('.name').html("<input id=\"txtEdit\" type=\"text\" class=\"nametextbox\" value=\"" +
                                        $(this).parent().find('.name').text() + 
                                        "\" / ><span class=\"oldValue\">" + 
                                        $(this).parent().find('.name').text() + "</span>");
    $(this).parent().find('.rename').hide();
    $(this).parent().find(".editbuttons").fadeIn();
    $(this).parent().find(".nametextbox").focus().select();
    $(this).parent().removeClass('editable');

    //submit wizard by pressing enter on the name textbox
    $("#txtEdit").keydown(function (e) {
		if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
            $(this).parent().parent().find('div.editbuttons span.save').click();
			return false;
		} else if ((e.which && e.which == 27) || (e.keyCode && e.keyCode == 27)) {
            $(this).parent().parent().find('div.editbuttons span.cancel').click();
			return true;
		}
    });
    return false;
});

//rename machine
$(".editbuttons .save").live('click', function() {
    serverID = $(this).closest('.machine-container').attr("id");
    serverName = $(this).parent().parent().find('.name').find('.nametextbox').val();
    if (serverName.trim() == ''){
        return false;
    }
    $(this).parent().parent().find('.name').html($(this).parent().parent().find('.nametextbox').val());
    $(this).parent().parent().find(".editbuttons").fadeOut("fast");
    $(this).parent().parent().find(".rename").fadeIn("slow");
    rename(serverID, serverName);
    return false;
});

//cancel renaming
$(".editbuttons .cancel").live('click', function() {
    $(this).parent().parent().find('.name').html($(this).parent().parent().find('.name').find('.oldValue').text());
    $(this).parent().parent().find(".editbuttons").hide();
    $(this).parent().parent().find(".rename").fadeIn();
    $(this).parent().parent().addClass('editable');
});

// intercept reboot click 
$("div.actions a.action-reboot").live('click', function(){
    var serverID = $(this).parent().parent().parent().attr("id");
    var serverName = $(this).parent().prevAll("div.name").find("span.name").text();
    var found = false;
    
    $(this).parent().children('a').removeClass('selected');
    $(this).addClass('selected');
    $(this).parent().addClass('display');
    $(this).parent().parent().find('.action_error').hide();
    for (i=0;i<pending_actions.length;i++){ // if there is already a pending action for this server replace it
        if (pending_actions[i][1]==serverID){
            pending_actions[i][0] = reboot;
            found = true
        }
    }
    if (!found) // no pending action for this server was found, so let's just add it to the list
        pending_actions.push([reboot, serverID, serverName])
    update_confirmations();
    return false;
});

// intercept shutdown click
$("div.actions a.action-shutdown").live('click', function(){ 
    var serverID = $(this).parent().parent().parent().attr("id");
    var serverName = $(this).parent().prevAll("div.name").find("span.name").text();
    var found = false;
    $(this).parent().children('a').removeClass('selected');
    $(this).addClass('selected');
    $(this).parent().addClass('display')
    $(this).parent().parent().find('.action_error').hide();

    for (i=0;i<pending_actions.length;i++){ // if there is already a pending action for this server replace it
        if (pending_actions[i][1]==serverID){
            pending_actions[i][0] = shutdown;
            found = true
        }
    }
    if (!found) // no pending action for this server was found, so let's just add it to the list 
        pending_actions.push([shutdown, serverID, serverName])
    update_confirmations();
    return false;
});

// intercept start click
$("div.actions a.action-start").live('click', function(){ 
    var serverID = $(this).parent().parent().parent().attr("id");
    var serverName = $(this).parent().prevAll("div.name").find("span.name").text();
    var found = false;
    $(this).parent().children('a').removeClass('selected');
    $(this).addClass('selected');
    $(this).parent().addClass('display')
    $(this).parent().parent().find('.action_error').hide();

    for (i=0;i<pending_actions.length;i++){ // if there is already a pending action for this server replace it
        if (pending_actions[i][1]==serverID){
            pending_actions[i][0] = start;
            found = true
        }
    }
    if (!found) // no pending action for this server was found, so let's just add it to the list
        pending_actions.push([start, serverID, serverName])
    update_confirmations();    
    return false;
});

// intercept console click
$("div.actions a.action-console").live('click', function(){
    var serverID = $(this).parent().parent().parent().attr("id");
    var serverName = $(this).parent().prevAll("div.name").find("span.name").text();
    var found = false;
    $(this).parent().children('a').removeClass('selected');
    $(this).addClass('selected');
    $(this).parent().addClass('display')
    $(this).parent().parent().find('.action_error').hide();

    for (i=0;i<pending_actions.length;i++){ // if there is already a pending action for this server replace it
        if (pending_actions[i][1]==serverID){
            pending_actions[i][0] = open_console;
            found = true
        }
    }
    if (!found) // no pending action for this server was found, so let's just add it to the list
        pending_actions.push([open_console, serverID, serverName])
    update_confirmations();
    return false;
});


// intercept destroy click
$("div.actions a.action-destroy").live('click', function(){ 
    var serverID = $(this).parent().parent().parent().attr("id");
    var serverName = $(this).parent().prevAll("div.name").find("span.name").text();
    var found = false;
    $(this).parent().children('a').removeClass('selected');
    $(this).addClass('selected');
    $(this).parent().addClass('display')
    $(this).parent().parent().find('.action_error').hide();

    for (i=0;i<pending_actions.length;i++){ // if there is already a pending action for this server replace it
        if (pending_actions[i][1]==serverID){
            pending_actions[i][0] = destroy;
            found = true
        }
    }
    if (!found) // no pending action for this server was found, so let's just add it to the list
        pending_actions.push([destroy, serverID, serverName])
    update_confirmations();    
    return false;
});

$("div.confirm_single .yes").live('click', function(){
    var serverID = $(this).parent().parent().parent().attr("id");
    for (i=0;i<pending_actions.length;i++){ // if there is a pending action for this server execute it
        if (pending_actions[i][1]==serverID){
            action = pending_actions.splice(i,1)[0]; // extract action
            // change the status text in cases where no api state exists
            if (action[0] == start) {
                $(this).parent().parent().find('.status').text('Starting');
                $(this).parent().parent().find('.spinner').show();
            } else if (action[0] == shutdown) {
                $(this).parent().parent().find('.status').text('Shutting down');
                $(this).parent().parent().find('.spinner').show();
            } else if (action[0] == reboot) {
                $(this).parent().parent().find('.status').text('Rebooting');
                $(this).parent().parent().find('.spinner').show();
            }  else if (action[0] == destroy) {
                $(this).parent().parent().find('.status').text('Destroying');
                $(this).parent().parent().find('.spinner').show();
            }                    
            action[0]([action[1]]); // execute action
        }
    }
    $(this).parent().hide();
    $(this).parent().parent().children('div.actions').children('a').removeClass('selected');
    $(this).parent().parent().children('.state').children('.spinner').show()
    $(this).parent().parent().children('div.actions').removeClass('display');
    update_confirmations(); 
    return false;
});

$("div.confirm_single .no").live('click', function(){
    // remove the action from the pending list
    var serverID = $(this).parent().parent().parent().attr("id");
    
    $(this).parent().parent().children('div.actions').children('a').removeClass('selected');
    $(this).parent().parent().children('div.actions').removeClass('display');    
    for (i=0;i<pending_actions.length;i++){ // if there is a pending action for this server remove it
        if (pending_actions[i][1]==serverID){
            pending_actions.splice(i,1);
        }
    }
    $(this).parent().hide();
    update_confirmations();    
    return false;
});

$("div.action_error .details").live('click', function(){
    // remove the action from the pending list
    ajax_error($(this).parent().children('.code').text(), undefined, $(this).parent().children('.action').text(), $(this).parent().children('.message').text());
    $(this).parent().hide();
});


// update the servers list
function update_machines_view(data){
    /* 
    Go through the servers in the input data. Update existing entries, add
    new ones to the list
    */
    
    $.each(data.servers.values, function(i,server){
    
        existing = $('#' + server.id);
        
        // if multiple machines exist in the DOM, delete all but one
        // defensive coding - that shouldn't happen normally
        while (existing.length > 1){
            existing.remove();
        }

        var server_image = os_icon(server.metadata);

        // server already exists in DOM
        if (existing.length){
            $("div.machine-container:last-child").find("div.separator").show();                
            //  if the status is deleted, delete it from the DOM
            if (server.status == 'DELETED') {
                existing.remove();
                try {
                    console.info(existing.find("div.name span.name").text() + ' removed');
                } catch(err) {}            
            } else if (existing.find(".status").text() != STATUS_MESSAGES[server.status]) {
                try { // firebug console logging
                    console.info(existing.find("div.name span.name").text() + ' from ' 
                                + existing.find(".status").text() + ' to ' + STATUS_MESSAGES[server.status]);
                } catch(err) {}
                // show console action only on active servers, else hide it
                if (server.status == 'ACTIVE') {
                    $('div.#' + server.id + ' a.action-console').attr('style','');
                    $('div.#' + server.id + ' a.action-shutdown').removeClass('shutdown-padding');        
                } else {
                    $('div.#' + server.id + ' a.action-console').hide();
                }
                // show reboot and shutdown actions on active of rebooting servers
                if (server.status == 'ACTIVE' || server.status == 'REBOOT') {                   
                    $('div.#' + server.id + ' a.action-reboot').attr('style','');
                    $('div.#' + server.id + ' a.action-shutdown').attr('style','');
                    $('div.#' + server.id + ' a.action-destroy').removeClass('destroy-padding');        
                }
                if (['BUILD','ACTIVE','REBOOT'].indexOf(server.status) >= 0 &&
                    [STATUS_MESSAGES['STOPPED'], STATUS_MESSAGES['ERROR'],
                     'Starting'].indexOf(existing.find(".status").text()) >= 0) {
                    // from stopped, on error or starting to building, active or rebooting
                    // starting is not an api state, it means the vm is stopped or on error
                    moved = existing.clone().appendTo(".running");
                    moved.find("img.logo").attr("src","static/machines/" + server_image + '-on.png');
                    existing.remove();
                    existing = moved;
                    existing.find(".status").text(STATUS_MESSAGES[server.status]); 
                } else if (['STOPPED','ERROR'].indexOf(server.status) >= 0 &&
                           [STATUS_MESSAGES['ACTIVE'], STATUS_MESSAGES['BUILD'], STATUS_MESSAGES['REBOOT'],
                            'Shutting down', 'Starting'].indexOf(existing.find(".status").text()) >= 0) {
                    // from active, building, rebooting, or shutting down to stopped or on error
                    // shutting down is not an api state, it means the server is active
                    moved = existing.clone().appendTo(".terminated");
                    moved.find("img.logo").attr("src","static/machines/" + server_image + '-off.png');
                    existing.remove();
                    existing = moved;
                    existing.find(".status").text(STATUS_MESSAGES[server.status]); 
                } else if (['BUILD','ACTIVE','REBOOT'].indexOf(server.status) >= 0 && 
                            [STATUS_MESSAGES['ACTIVE'], STATUS_MESSAGES['BUILD'],
                             STATUS_MESSAGES['REBOOT']].indexOf(existing.find(".status").text()) >= 0) {
                    // the server changes status, but remains in running list
                    existing.find(".status").text(STATUS_MESSAGES[server.status]); 
                } else if (['STOPPED','ERROR'].indexOf(server.status) >= 0 &&
                    [STATUS_MESSAGES['STOPPED'], 
                     STATUS_MESSAGES['ERROR']].indexOf(existing.find(".status").text()) >= 0) {
                    // the server changes status, but remains in terminated list
                    existing.find(".status").text(STATUS_MESSAGES[server.status]); 
                }        
                existing.find('.spinner').hide();
                existing.find(' .wave').attr('src','static/wave.gif').show();
                setTimeout("$('#" + server.id +" .wave').attr('src','').hide()", 3000);
                // show spinner while the server is rebooting, starting or shutting down  
                if ([STATUS_MESSAGES['REBOOT'], 
                    'Starting', 'Shutting down'].indexOf(existing.find(".status").text()) >= 0 ) {
                    existing.find(' .wave').hide();
                    existing.find('.spinner').show();
                }                            
            } else if (existing.find(".status").text() == STATUS_MESSAGES['REBOOT'] && server.status == 'REBOOT') {
                    $('div.#' + server.id + ' a.action-console').hide();
                    $('div.#' + server.id + ' a.action-shutdown').addClass('shutdown-padding');
            }
            //existing.find(".status").text(STATUS_MESSAGES[server.status]);
            if (existing.find(".editbuttons").css('display') == 'none') { 
                existing.find("div.name span.name").text(server.name.substring(0,100));
            } else {
                existing.find(".editbuttons .cancel").click();
                existing.find("div.name span.name").text(server.name.substring(0,100));
            }
            existing.find("a.ip span.public").text(String(server.addresses.values[0].values[0].addr).replace(',',' '));
        } else if (server.status != 'DELETED') {
            // If it does not exist and it's not deleted, we should create it
            var machine = $("#machine-container-template").clone().attr("id", server.id).fadeIn("slow");
            machine.find(".scrollable").scrollable({ vertical: true});	
            machine.find("div.name span.name").text(server.name.substring(0,100));
            machine.find("img.logo").attr("src","static/machines/"+server_image+'-on.png');
            machine.find("span.imagetag").text(server_image);
            machine.find("a.ip span.public").text(String(server.addresses.values[0].values[0].addr).replace(',',' '));            
            machine.find(".status").text(STATUS_MESSAGES[server.status]);
            // find and display flavor parameters
            var CPUs, RAM, disk, image_name, image_size;
            if ( flavors.length > 0 ) {
                var current_flavor = '';
                for (i=0; i<flavors.length; i++) {
                    if (flavors[i]['id'] == server.flavorRef) {
                        current_flavor = flavors[i];
                    }
                } 
                CPUs = current_flavor['cpu'];
                RAM = current_flavor['ram']; 
                disk = current_flavor['disk']; 
            } else {
                CPUs = 0;
                RAM = 0;        
                disk = 0;     
            }
            if ( images.length > 0 ) {
                var current_image = '';
                for (i=0; i<images.length; i++) {
                    if (images[i]['id'] == server.imageRef) {
                        current_image = images[i];
                    }
                }       
                image_name = current_image['name'];
                image_size = current_image['metadata']['values']['size'];
            } else {
                image_name = ''
                image_size = ''
            }
            machine.find(".cpu-data").text(CPUs);
            machine.find(".ram-data").text(RAM);
            machine.find(".disk-data").text(disk);
            machine.find(".image-data").text(image_name.substring(0,15));
            machine.find(".image-size-data").text(image_size);
            get_metadata(server.id);
            //populate metadata
            if (['BUILD', 'ACTIVE', 'REBOOT'].indexOf(server.status) >= 0){
                machine.appendTo(".running");
            } else {
                machine.find("img.logo").attr("src","static/machines/"+server_image+'-off.png');
                machine.appendTo(".terminated");
            }
            //show spinner while machine is building
            if (server.status == 'BUILD' || 
                ['Starting', 'Shutting down'].indexOf(existing.find(".status").text()) >= 0 ) { 
                machine.find('.spinner').show();
            }   
            //disable reboot and shutdown actions while machine is building
            if (server.status == 'BUILD') {
                $('div.#' + server.id + ' a.action-reboot').hide();
                $('div.#' + server.id + ' a.action-shutdown').hide();
                $('div.#' + server.id + ' a.action-destroy').addClass('destroy-padding');        
            }
            // show console action only on active servers
            if (server.status == 'ACTIVE') {
                $('div.#' + server.id + ' a.action-console').attr('style','');
            } else if (server.status == 'REBOOT'){
                $('div.#' + server.id + ' a.action-console').hide();
                $('div.#' + server.id + ' a.action-shutdown').addClass('shutdown-padding');
            } else {
                $('div.#' + server.id + ' a.action-console').hide();
            }
        } 
    });

    $("#spinner").hide();
    // show all separators
    $("div.machine-container div.separator").show();
    // hide the last one
    $("div.machine-container:last-child").find("div.separator").hide();
    // the separator shows only when running and terminated machines are available
    if ($(".terminated div.name").length > 0 && $(".running div.name").length > 0) {
        $("#mini.separator").fadeIn("slow");
    } else {
        $("#mini.separator").fadeOut("slow");
    }
    
    // show message in case user has no servers!
    if ($('.machine-container').length < 2) {
        showWelcome();
    } else {
        hideWelcome();
    }
    
    // set confirm box position
    if (window.innerHeight - 220 < $('#machinesview').height())
        $('.confirm_multiple').addClass('fixed');
    else
        $('.confirm_multiple').removeClass('fixed');
}

// update metadata list
function list_metadata_keys(serverID, data) {    
    // empty the list if it already exists
    $("div.#" +serverID).find("div.items").empty();
    // get the values to show
    meta = data.metadata.values;
    //start counter
    var i=0;
    // show values
    for (key in meta) {
        $("div.#" +serverID).find(".items").append("<div class='item'>" + key + "</div>");
        i++
    }
    //hide the metadata controls if we have less than 3 metadata
    if (i <= 3) {
        $("div.#" +serverID).find(".metadata-actions").hide();
    }
    //show the metadata controls if we have more than 3 metadata
    if (i > 3) {
        $("div.#" +serverID).find(".metadata-actions").show();
    }
    $("div.#" +serverID).find(".metadata-count").text(i);   
}

// indicate that the requested action was succesfully completed
function display_success(serverID) {

}

// indicate that the requested action was not completed
function display_failure(status, serverID, action, responseText) {
    $('#'+serverID+ ' .spinner').hide();
    $('#'+serverID+ ' .action_error .action').text(action);
    $('#'+serverID+ ' .action_error .code').text(status);
    $('#'+serverID+ ' .action_error .message').text(responseText);
    $('#'+serverID+ ' .action_error').show();    
}

// basic functions executed on page load
if ( flavors.length == 0 && images.length == 0 ) {
    // configure flavors, this also calls update_vms(UPDATE_INTERVAL)
    update_flavors();
    // populate image list
    update_images(); 
} else if ( flavors.length == 0 && images.length != 0 ) {
    // configure flavors, this also calls update_vms(UPDATE_INTERVAL)
    update_flavors();
} else if ( flavors.length != 0 && images.length == 0 ) {
    // populate image list
    update_images(); 
    update_vms(UPDATE_INTERVAL);
} else {
    // start updating vm list
    update_vms(UPDATE_INTERVAL);
}

// set the label of the multiple buttons 
$('div.confirm_multiple button.yes').text('Confirm All');
$('div.confirm_multiple button.no').text('Cancel All');

// reposition multiple confirmation box on window resize
$(window).resize(function(){
    if (this.innerHeight - 220 < $('#machinesview').height())
        $('.confirm_multiple').addClass('fixed');
    else
        $('.confirm_multiple').removeClass('fixed');
});


</script>
