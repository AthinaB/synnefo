{% load i18n %}

<div id="machinesview" class="list">
    <div id="spinner"></div>
    <div class="actions">
        <a id="action-start">Start</a>
        <a id="action-reboot">Reboot</a>
        <a id="action-shutdown">Shutdown</a>
        <br />
        <a id="action-destroy">Destroy</a>
        <br />
        <a id="action-details">Show Details</a>
        <a id="action-group">Add to group</a>
        <br />
        <a id="action-band">Out of band</a>
        <br />
        <a id="action-attach">Attach disk</a>
        <a id="action-detach">Detach disk</a>
        <br />
        <a id="action-connect">Connect to network</a>
        <a id="action-disconnect">Disconnect from net</a>
    </div>
    <table class="list-template" style="display: none">
        <tr id="machine-template" class="machine">
            <td><input type="checkbox" id="node-id" /></td>
            <td><span class="imagetag"></span><img class="list-logo" src="" width="16" height="16" /></td>
            <td><a class="name"><span class="name">node.name</span></a></td> 
            <td><a class="ip"><span class="public">node.public_ip</span></a></td>
            <td>group</td>
            <td class="status">Running</td>
        </tr>	
    </table>
    <table class="list-machines" style="display: none">
        <thead> 
            <tr> 
                <th id="selection" class="select-running">
                    <input type="checkbox"/>
                    <div class="expand-icon"></div>
                    <ul style="display: none">
                        <li class="select-all" ><a href="#">all</a></li>
                        <li class="select-none"><a href="#">none</a></li>
                        <li class="select-group"><a href="#">group</a></li>
                    </ul>            
                </th>
                <th id="os">OS</th> 
                <th id="name">Name</th> 
                <th id="ip">IP</th> 
                <th id="group">Group</th>
                <th id="status">Status</th> 
            </tr>
        </thead> 
        <tbody class="running terminated"></tbody>
    </table>
</div>

<script>
// select/deselect all from checkbox widget of table headers
$("table thead tr th#selection :checkbox").live('change', function() {
    if ( $(this).is(":checked") ) {
        $(":checkbox").attr("checked", true);
    }
    else {
        $(":checkbox").attr("checked", false);
    }
	updateActions();
});

// select all/none/group from drop down menu
$("table thead tr th#selection ul li").live('click', function() {
    // all or none?
    if ( $(this).attr("class") == "select-all" || $(this).attr("class") == "select-none") {
        var all = ($(this).attr("class") == "select-all");
        // toggle checkboxes
        $(":checkbox").attr("checked", all);
    } else if ($(this).attr("class") == "select-group"){
        // TODO: This shoud select only the vms in the selected group
        // right now the folowing has the functionality of select-all        
        $(":checkbox").attr("checked", true);
    }
    // update actions
	updateActions();
	return false;
});

// menu toggle, running menu
$("table.list-machines thead tr th#selection div.expand-icon").live('click', function () {
	$("table.list-machines thead tr th#selection ul").slideToggle('medium');
    return false;
});

$("table.list-machines thead tr th#selection ul").live('click', function () {
	$("table.list-machines thead tr th#selection ul").slideToggle('medium');
    return false;
});

// TODO: This should be populated with more rules for all available states
var actions = { 'reboot':		['ACTIVE', 'REBOOT', 'multiple'],
				'shutdown':		['ACTIVE', 'REBOOT', 'multiple'],
				'connect':		['ACTIVE', ],
				'disconnect':	['ACTIVE', 'network'],
				'band':			['ACTIVE', 'REBOOT'],
				'details':		['ACTIVE', 'REBOOT', 'STOPPED'],
				'start': 		['STOPPED', 'multiple'],
				'destroy':		['ACTIVE', 'STOPPED', 'REBOOT', 'multiple'],
				'group':		['ACTIVE', 'STOPPED', 'REBOOT','multiple'],
			   };

// on checkbox click, update the actions
$("tbody input[type='checkbox']").live('change', function() { updateActions(); });

// destroy action
$("a.enabled#action-destroy").live('click', function() {
	var checked = $("table.list-machines tbody input[type='checkbox']:checked");
	var serverIDs = [], serverNames=[];
	checked.each(function(i,c) {
		serverID=c.id.replace('input-','');
		serverIDs.push(serverID);
		serverNames.push($('tr#'+serverID+' span.name').text());
	});
	confirm_action('destroy', destroy, serverIDs, serverNames);
	return false;
});


$("a.enabled#action-reboot").live('click', function() {
	var checked = $("table.list-machines tbody input[type='checkbox']:checked");
	var serverIDs = [], serverNames=[];
	checked.each(function(i,c) {
		serverID=c.id.replace('input-','');
		serverIDs.push(serverID);
		serverNames.push($('tr#'+serverID+' span.name').text());
	});
	confirm_action('reboot', reboot, serverIDs, serverNames);
	return false;
});


$("a.enabled#action-start").live('click', function() {
	var checked = $("table.list-machines tbody input[type='checkbox']:checked");
	var serverIDs = [], serverNames=[];
	checked.each(function(i,c) {
		serverID=c.id.replace('input-','');
		serverIDs.push(serverID);
		serverNames.push($('tr#'+serverID+' span.name').text());
	});
//	confirm_action('start', start, serverIDs, serverNames);
    start(serverIDs);
	return false;
});


$("a.enabled#action-shutdown").live('click', function() {
	var checked = $("table.list-machines tbody input[type='checkbox']:checked");
	var serverIDs = [], serverNames=[];
	checked.each(function(i,c) {
		serverID=c.id.replace('input-','');
		serverIDs.push(serverID);
		serverNames.push($('tr#'+serverID+' span.name').text());
	});
	confirm_action('shutdown', shutdown, serverIDs, serverNames);
	return false;
});

// TODO
function update_machines_view(data){
    /*
    Go through the already displayed running servers and remove those not in
    the data or are marked as deleted.
    */
    $('.running .machine').each(function(i,entry) {
        var deleted = true;
        $.each(data.servers, function(j,server) {
            if (server.id == entry.id && ['BUILD','ACTIVE'].indexOf(server.status) >= 0) {
                deleted = false;
            }
        });
        if (deleted) {
            entry.remove();
        }
    });
    // Do the same for the terminated ones.
    $('.terminated .machine').each(function(i,entry) {
        var deleted = true;
        $.each(data.servers, function(j,server) {
            if (server.id == entry.id && ['STOPPED','ERROR'].indexOf(server.status) >= 0) {
                deleted = false;
            }
        });
        if (deleted) {
            entry.remove();
        }    
    });
    /* 
    Then go through the servers in the input data. Update existing entries, add
    new ones to the list
    */    
    $.each(data.servers, function(i,server){
        // if the machine is deleted it should not be included in any list
        if (server.status == 'DELETED') {
            return;
        }
        
        existing = $('#'+server.id);
        
        if (existing.length>1){
            existing.remove();
            existing = [];
        }   
        
        if (existing.length){ // simply update the values
            // TODO
        } else { // does not exist, we should create it
            var machine = $("#machine-template").clone().attr("id", server.id).fadeIn("slow");
            machine.find("input[type='checkbox']").attr("id", "input-" + server.id);
            machine.find("input[type='checkbox']").attr("class", server.status);
            machine.find("a.name span.name").text(server.name);
            machine.find("img.logo").attr("src","static/machines/"+image_tags[server.imageId]+'.png');
            machine.find("img.list-logo").attr("src","static/os_logos/"+image_tags[server.imageId]+'.png');
            machine.find("img.list-logo").attr("title",image_tags[server.imageId]);
            machine.find("span.imagetag").text(image_tags[server.imageId]);
    
            machine.find("a.ip span.public").text(String(server.addresses.public.ip.addr).replace(',',' '));            
    
            if (server.status == 'BUILD'){
                machine.find(".status").text('Building');
                machine.appendTo(".running");
            } else if (server.status == 'ACTIVE') {
                machine.find(".status").text('Running');
                machine.appendTo(".running"); 
            } else if (server.status == 'REBOOT' || server.status == 'HARD_REBOOT') {
                machine.find(".status").text('Rebooting');
                machine.appendTo(".running");
            } else if (server.status == 'STOPPED') {
                machine.find(".status").text('Stopped');
                machine.find("img.logo").attr("src","static/machines/"+image_tags[server.imageId]+'-off.png');
                machine.find("img.list-logo").attr("src","static/os_logos/"+image_tags[server.imageId]+'-off.png');
                machine.appendTo(".terminated");
            } else if (server.status == 'ERROR') {
                machine.find(".status").text('Error');
                machine.find("img.logo").attr("src","static/machines/"+image_tags[server.imageId]+'-off.png');
                machine.find("img.list-logo").attr("src","static/os_logos/"+image_tags[server.imageId]+'-off.png');
                machine.appendTo(".terminated");
            } 
            else {
                machine.find(".status").text('Unknown');
                machine.find("img.logo").attr("src","static/machines/"+image_tags[server.imageId]+'-off.png');
                machine.find("img.list-logo").attr("src","static/os_logos/"+image_tags[server.imageId]+'-off.png');
                machine.appendTo(".terminated");
            }
        }
    });
	
    // creating the table in list view, if there are machines to show
    if ($("div.list table.list-machines tbody").length > 0) {
        $("div.list table.list-machines").dataTable({
            "bInfo": false,
            "bPaginate": false,
            "bAutoWidth": false,
            "bSort": true,    
            "bStateSave": true,
            "sScrollY": "270px",
            "sScrollX": "515px",
            "sScrollXInner": "500px",
            "aoColumnDefs": [
                { "bSortable": false, "aTargets": [ 0 ] }
            ]
        });
        $("div.list table.list-machines").show();
        $("div.list div.actions").show();
    }
    $("#spinner").hide();	
}

update_vms();

</script>
