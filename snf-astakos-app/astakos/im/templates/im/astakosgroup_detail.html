{% extends "im/account_base.html" %}

{% load filters %}

{% block page.body %}
{% with object.owners as owners %}
 
<div class="projects">

	<h2>
	 	{% if object.is_member %}
			<em>
				{% if object.is_owner %}
					[ ADMINISTRATOR ]
				{%  else %}
					[ ENROLLED ]
				{% endif %}
			</em>		
		{% endif %}
	 	<span>{{ object.name|strip_http|upper }}</span>
	 </h2>
	 
	 <div class="details">
	 	{% if object.is_owner %}
	 		<a href="#" class="edit">EDIT GROUP INFO</a>
	 	{% endif %}
	 	<div class="data">
		 	<p>{{ object.desc }}</p>
		 	<dl class="alt-style">
			 	<dt>Homepage url</dt>
			 	<dd>
			 		{% if object.homepage%}
			 			<a href="{{ object.homepage }}">{{ object.homepage }}</a>
			 		{% else %}
			 			Not set yet
			 		{% endif %}
			 	</dd>
			 </dl>
		</div>
		<div class="editable" style="display:none;">
		<form action="" method="post"
	            class="withlabels">{% csrf_token %}
	            {% with update_form as form %}
                    {% include "im/form_render.html" %}
                    <div class="form-row submit">
                        <input type="submit" class="submit altcol" value="FINISHED EDITING" />
                    </div>
	            {% endwith %}
	    </form>
		</div>
	 </div>
	 <div class="full-dotted">
		 <h3>DETAILS:</h3>
		 <dl class="alt-style">
		 	<dt>Name</dt>
		 	<dd>{{ object.name|strip_http }}&nbsp;</dd>
		 	<!--<dt>Type</dt>
		 	<dd>{{object.kindname|capfirst}}&nbsp;</dd>-->
		 	<dt>Issue date:</dt>
		 	<dd>{{object.issue_date|date:"d/m/Y"}}&nbsp;</dd>
		 	<dt>Expiration Date</dt>
		 	<dd>{{object.expiration_date|date:"d/m/Y"}}&nbsp;</dd>
		 	<dt>Modaration</dt>
		 	<dd>{% if object.moderation_enabled%}Yes{% else %}No{% endif %}</dd>
		 	<dt>Activated</dt>
		 	<dd>{% if object.is_enabled %}Yes{% else %}No{% endif %}</dd>
		 	<dt>Owner</dt>
		 	{{ o.owners }}
		 	<dd>{% for o in owners %}
                    {% if object.is_owner %}
                        Me
                    {% else%}
                        {{o.realname}} ({{o.email}})
                    
                    {% endif %}
                {% endfor %}&nbsp;
            </dd>
            <dt>Max participants</dt>
		 	<dd>{% if object.max_participants%}{{object.max_participants}}{% else %}&nbsp;{% endif %}</dd>
		 </dl>
	 </div>
	 <div class="full-dotted">
		 <h3>RESOURCES:</h3>		 
		 {% if quota %}
		 <dl class="alt-style">	
	 		{% for q in quota %}
		 		 
		 		<dt>
       				Max {% if q.is_abbreviation %}{{ q.verbose_name|upper }}{% else %}{{ q.verbose_name }}{% endif %}{% if not q.unit %}s {% endif  %}  per user
       			</dt>
		 		<dd>
       			{% if q.value %}
       				 {% if q.unit %}
       				 	{{ q.value|sizeof_fmt }}
       				 {% else %}
       				 	{{ q.value|isinf }}
       				 {% endif %}
       			{% else %}
       				Unlimited
       			{% endif %}
       			</dd>
	 		{% endfor %}
	 	</dl>
		{% else %}
            <p>No resources</p>
        {% endif %} 
	 </div>
     
	 <div class="full-dotted">
	    {% with page|concat:sorting as args %}
	    {% with object.membership_set.select_related.all|paginate:args as membership %}
            {% if membership %}
            <form method="GET" class="minimal" action="#members-table">
                <div class="form-row">
                    <select name="sorting" onchange="this.form.submit();" class="dropkicked">
                        <option value="">Sort by</option>
                        <option value="person__email" {% if sorting == 'person__email' %}selected{% endif %}>User Id</option>
                        <option value="person__first_name" {% if sorting == 'person__first_name' %}selected{% endif %}>Name</option>
                        <option value="date_joined" {% if sorting == 'date_joined' %}selected{% endif %}>Status</option>
                    </select>
                </div>
            </form>
             <table class="alt-style" id="members-table">
                <caption>MEMBERS:</caption>
                <thead>
                    <tr>
                        <th>User Id</th>
                        <th>Name</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                {% for m in membership.object_list %}
                  <tr>
                    <td>{{m.person.email}}</td>
                    <td>{{m.person.realname}}</td>
                    {% if m.person in owners %}
                    <td>Owner</td>
                    {% else %}
                        {% if m.is_approved %}
                        <td>Approved</td>
                        {% else %}
                        <td>Pending
                            {% if object.is_owner %}
                                <a href="{% url approve_member object.id m.person.id %}?{% if page %}page={{ page }}{% endif %}{% if sorting %}&sorting={{sorting}}{% endif %}">Accept</a>
                                <a href="{% url disapprove_member object.id m.person.id  %}?{% if page %}page={{ page }}{% endif %}{% if sorting %}&sorting={{sorting}}{% endif %}">Reject</a>
                            {% endif %}
                        </td>    
                        {% endif %}
                    {% endif %}
                  </tr>
                {% endfor %}
                </tbody>
             </table>
             <div class="pagination">
                <p class="next-prev">
                    {% if membership.has_previous %}
                        <a href="?page={{ membership.previous_page_number }}{% if sorting %}&sorting={{sorting}}{% endif %}">previous</a>
                    {% endif %}
                    {% if membership.has_next %}
                        <a href="?page={{ membership.next_page_number }}{% if sorting %}&sorting={{sorting}}{% endif %}">next</a>
                    {% endif %}
                </p>
                <p class="nums">
                    <span class="current">
                        Page {{ membership.number }} of {{ membership.paginator.num_pages }}
                    </span>
                </p>
            </div>
             {% else %}
                <p>No members yet!</p>
            {% endif %}
        {% endwith %}
        {% endwith %}
	 </div>
     
     
    {% if object.is_owner %}
    <div class="full-dotted">
        <form action="" method="post" class="withlabels">{% csrf_token %}
            <h2>Enroll more members</h2>
                {% with addmembers_form as form %}
                    {% include "im/form_render.html" %}
                {% endwith %}
                <div class="form-row submit">
                    <input type="submit" class="submit altcol" value="ADD MEMBERS" />
                </div>
        </form>
    </div>
    {% endif %}
     
    
</div>
 
{% endwith %}
{% endblock %}
